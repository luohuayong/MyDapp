<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>星云之王</title>

  <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">
</head>

<body>

  <div class="container">

    <div class="jumbotron">
      <h1 class="text-center">星云之王 </h1>

      <h2 class="text-left">
        <small>星云链上的智能合约将让您成为国王，给您带来财富，并让您的名字永存。</small>
      </h2>
      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="h4 text-center">国王大厅</div>
        </div>
        <div class="panel-body">
          <div class="input-group form-group input-group-lg">
            <input type="text" class="form-control" placeholder="请给新国王取个响亮的名称" id="txtNick">
            <span class="input-group-btn">
              <button class="btn btn-primary" type="button" onclick="btnBuyClick();" id="btnBuy">成为新的国王</button>
            </span>
          </div>

          <table class="table table-striped table-hover">
            <thead>
              <tr class="info">
                <td>序号</td>
                <td>名字</td>
                <td>支付价格</td>
                <td>地址</td>
              </tr>
            </thead>
            <tbody id="hallTable">
              <tr>
                <td>1</td>
                <td>King</td>
                <td>0.5NAS</td>
                <td>n1Y6GnGntC5WHMjYVmPKgitnC3bPdyFUm1L</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>


      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="h4 text-center">合约规则</div>
        </div>
        <div class="panel-body">
          <ul>
            <li>如果当前王位价格是10NAS</li>
            <li>您可以向合约发送10NAS成为新的星云之王</li>
            <li>您的名字将被添加到区块链，显示在国王大厅中</li>
            <li>合约将把您的10NAS扣除少量佣金后发送给被您篡位的上一届国王，作为补偿</li>
            <li>王位的价格提高33%，至13.3NAS。</li>
            <li>如果有一个新的篡位者出现，他可以驱逐您，成为新的国王。同时您将获取13.3NAS作为补偿(会扣除一小笔佣金)</li>
            <li>王位有一个古老的诅咒，每一位国王一旦统治达到14天就会死亡。</li>
            <li>如果发生这种情况，将不会收到任何补偿。并且王位的价格会恢复到0.5NAS的初始价格。</li>
            <li>但是，一个新的篡位者肯定会在14天中出现的，即使没有，至少您的名字会在区块链中永存</li>
          </ul>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="h4 text-center">常见问题</div>
        </div>
        <div class="panel-body">
          
          <h4>合约地址在哪里？</h4>
          <span id="dappAddress"></span>
          <br>
          <br>
          <h4>佣金比例是多少？</h4>
          5%
          <br>
          <br>
          <h4>当一位国王被诅咒赶下王位后，他的钱到哪里去了？</h4>
          额，我明白您的意思，但是并不像您想象的那样。当这种情况发生时，没有任何钱被贪污。 例如，如果新的国王支付了15NAS，这15NAS并不会被合约保留，而是在扣除小部分佣金后立即支付给了上届国王。 因此，如果某位国王被诅咒赶下了王位，他支付的15NAS并没有丢失，而是到了14天前被他篡位的国王钱包里了。
          只有一种情况，当有人以初始价格0.5NAS获取王位时，他的支付将全部作为佣金前往王位背后的“巫师”
          <br>
          <br>
          <h4>我认为出了问题。我可以拿回我的钱吗？</h4>
          额，您会发现，区块链上的智能合约执行不受任何人或组织的干预，即使是合约的编写者。此外，也没有任何钱可退，这些钱已经支付给了前任国王。 所以很遗憾，不会有退款，这既不可行也不道德。
          <br>
          <br>
          <h4>合约安全吗？</h4>
          正如免责声明中指出的那样，在实验加密货币的过程中，可能会存在这样或者那样的漏洞。但是我们已经付出了相当大的努力来减轻风险。
          <br>
          <br>
          <h4>放弃</h4>
          这是一个有趣的游戏，探索星云链上运行的智能合约能干什么。请不要支付您不能承受的价格，保持游戏的心态。
          <br>
          <br>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="h4 text-center">免责申明</div>
        </div>
        <div class="panel-body">
          <h4>请注意，在任何情况下都不会有退款或赔偿，即使因为合同漏洞而让您损失了所有钱。</h4>
          <h4>作者不承担所有合约在运行过程中出现的责任，您有责任在与合约交互之前考虑到其可能的行为，并同意接受本节中的条件。</h4>
        </div>
      </div>

    </div>


  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
    crossorigin="anonymous"></script>
  <script src="js/nebPay.js"></script>
  <script src="js/nebulas.js"></script>
  <script>



    var dappAddress = "n1vb4wJtD5vUsmRCNiPWvaMWyHYzsWuJQLP";

    var nebulas = require("nebulas");
    var Account = nebulas.Account;
    var neb = new nebulas.Neb();
    neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
    var currentPrice;

    function getPrice() {
      // var from = $("#myAddr").val(); 
      var from = Account.NewAccount().getAddressString();
      var value = "0";
      var nonce = "0"
      var gas_price = "1000000"
      var gas_limit = "2000000"
      var callFunction = "currentPrice";
      var callArgs = ""; //in the form of ["args"]
      var contract = {
        "function": callFunction,
        "args": callArgs
      }

      neb.api.call(from, dappAddress, value, nonce, gas_price, gas_limit, contract)
        .then(function (resp) {
          console.dir(resp);
          var result = resp.result;
          if (result === 'null') {
            // $("#nowLuckDigit").val(0);
            alert("网络错误");
          } else {
            // result = JSON.parse(result);
            // $("#nowLuckDigit").val(result);
            currentPrice = JSON.parse(result);
            currentPrice = neb.fromBasic(currentPrice).toNumber();
            $("#btnBuy").text("花费" + currentPrice + "NAS成为新的国王");
          }
        })
        .catch(function (err) {
          console.error(err);
        });
    }

    function getHall() {
      var from = Account.NewAccount().getAddressString();
      var value = "0";
      var nonce = "0"
      var gas_price = "1000000"
      var gas_limit = "2000000"
      var callFunction = "hall";
      var callArgs = "";
      var contract = {
        "function": callFunction,
        "args": callArgs
      }

      neb.api.call(from, dappAddress, value, nonce, gas_price, gas_limit, contract)
        .then(function (resp) {
          console.dir(resp);
          var result = resp.result;
          if (result === 'null') {
            alert("网络错误");
          } else {
            var obj = JSON.parse(JSON.parse(result));
            var html = createHallTable(obj.buyRecord);
            $("#hallTable").empty();
            $("#hallTable").prepend(html);
          }
        })
        .catch(function (err) {
          console.error(err);
        });
    }

    function createHallTable(buyRecord) {
      var result = '';
      for (var i in buyRecord) {
        item = buyRecord[i];
        var id = item.id;
        var nick = item.nick;
        var price = neb.fromBasic(item.price).toString() + "NAS";
        var address = item.address;
        var htmlItem = '<tr><td>' + id + '</td>' +
          '<td>' + nick + '</td>' +
          '<td>' + price + '</td>' +
          '<td>' + address + '</td></tr>';
        result = htmlItem + result;
      }
      return result;
    }

    var NebPay = require("nebpay");
    var nebPay = new NebPay();
    var serialNumber
    var intervalQuery;

    function btnBuyClick() {
      var nick = $("#txtNick").val(); 
      if(!nick){
        alert("请先填写国王名称");
        return;
      }
      var to = dappAddress;
      var value = currentPrice;
      var callFunction = "buy";
      // var nick = "user1"; // $("#newLuckDigit").val();
      var callArgs = '["' + nick + '"]';

      serialNumber = nebPay.call(to, value, callFunction, callArgs, { //使用nebpay的call接口去调用合约,
        listener: cbPush //设置listener, 处理交易返回信息
      });

    }

    function cbPush(resp) {
      console.log("response of push: " + JSON.stringify(resp))
    }

    $(document).ready(function () {
      if (typeof (webExtensionWallet) === "undefined") {
        alert("请先安装星云钱包插件.");
      }
      getPrice();
      getHall();
      $("#dappAddress").text(dappAddress);
    });
  </script>
</body>


</html>